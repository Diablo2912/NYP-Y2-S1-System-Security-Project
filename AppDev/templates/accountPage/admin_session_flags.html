{% extends "base.html" %}
{% block content %}

<style>
  /* ---------- Page shell ---------- */
  :root{
    --cz-green: #198754;
    --cz-surface: rgba(25,135,84,.06);
    --cz-border: rgba(25,135,84,.16);
    --cz-sticky-top: 96px; /* nav (~60) + toolbar (~36) */
  }
  .cz-hero{
    background: linear-gradient(180deg, rgba(25,135,84,.07), rgba(25,135,84,.04));
    border: 1px solid var(--cz-border);
    border-radius: 16px;
    padding: 1rem 1.25rem;
    margin-top: 1rem;
  }
  .cz-hero h1{
    font-size: clamp(1.4rem, 1.1rem + 1.2vw, 2rem);
    margin: 0;
    font-weight: 800;
    letter-spacing: .2px;
  }
  .cz-subtle{
    color: var(--bs-secondary-color, #6c757d);
    font-size: .95rem;
  }
  .cz-pills{ display:flex; gap:.5rem; flex-wrap:wrap; }
  .cz-pill{
    background:#fff; border:1px solid var(--cz-border);
    border-radius:999px; padding:.25rem .6rem; font-weight:600;
  }

  /* ---------- Sticky toolbar (filter + actions) ---------- */
  .cz-toolbar{
    position: sticky; top: 64px; /* below global navbar */
    z-index: 5;
    backdrop-filter: blur(6px);
    background: rgba(255,255,255,.82);
    border-bottom: 1px solid rgba(0,0,0,.06);
    padding: .6rem .25rem;
    margin: .25rem 0 1rem;
  }
  @media (max-width: 991.98px){
    :root{ --cz-sticky-top: 56px; }
    .cz-toolbar{ top: 56px; }
  }

  /* ---------- Table layout tweaks (unchanged logic) ---------- */
  .table-flags th, .table-flags td { vertical-align: middle; }
  .table-flags .col-when   { width: 16%; }
  .table-flags .col-user   { width: 22%; }
  .table-flags .col-details{ width: 16%; }
  .table-flags .col-reason { width: 28%; text-align: center; }
  .table-flags .col-status { width: 8%;  white-space: nowrap; text-align: center; }
  .table-flags .col-view   { width: 10%; white-space: nowrap; text-align: center; }
  .table-flags .col-act    { width: 10%; white-space: nowrap; text-align: center; }

  /* Optional sticky table header (uncomment if you like it)
  .table-sticky thead th{
    position: sticky; top: var(--cz-sticky-top);
    z-index: 3; background: #f8fbf9;
    box-shadow: inset 0 -1px 0 rgba(0,0,0,.05), 0 1px 0 rgba(0,0,0,.05);
  } */

  .badge-chip { border-radius: 999px; padding: .35rem .6rem; font-weight: 600; }
  .btn-chip   { border-radius: 999px; padding: .35rem .9rem; }
  .btn-outline-dark.btn-chip { padding: .35rem .9rem; }

  .collapse-card { max-height: 220px; overflow: auto; }

  /* Row tints for quick scanning */
  tr.table-warning { background-color: #fff8e1 !important; }
  tr.table-success { background-color: #eefaf0 !important; }
  tr.table-light   { background-color: #f6f7fb !important; }
</style>

<div class="container">

  <!-- Hero header -->
  <div class="cz-hero">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div>
        <h1>🚩 Session Flags</h1>
        <div class="cz-subtle">Review, resolve, or dismiss user-reported session concerns.</div>
      </div>

      {# Optional quick stats if you pass a 'stats' dict: {'OPEN':x,'RESOLVED':y,'DISMISSED':z} #}
      {% if stats %}
      <div class="cz-pills">
        <span class="cz-pill">Open: <strong>{{ stats.OPEN or 0 }}</strong></span>
        <span class="cz-pill">Resolved: <strong>{{ stats.RESOLVED or 0 }}</strong></span>
        <span class="cz-pill">Dismissed: <strong>{{ stats.DISMISSED or 0 }}</strong></span>
      </div>
      {% endif %}
    </div>

    <!-- Tiny legend to decode colors -->
    <div class="d-flex align-items-center gap-2 mt-2 flex-wrap">
      <span class="cz-subtle me-1">Legend:</span>
      <span class="badge badge-chip bg-danger">Unknown Login</span>
      <span class="badge badge-chip bg-warning text-dark">Suspicious Activity</span>
      <span class="badge badge-chip bg-primary">Unrecognized Actions</span>
      <span class="badge badge-chip bg-secondary">Other</span>
    </div>
  </div>

  <!-- Sticky toolbar -->
  <div class="cz-toolbar">
    <div class="d-flex align-items-center justify-content-between">
      <div class="cz-subtle">Showing:
        <strong>{{ status_filter|title if status_filter else 'Open' }}</strong>
      </div>

      {% if status_filter is defined %}
      <form class="d-flex align-items-center gap-2" method="get" action="{{ url_for('view_session_flags') }}">
        <label class="fw-semibold">Status:</label>
        <select name="status" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
          <option value="OPEN"      {{ 'selected' if status_filter=='OPEN' }}>Open</option>
          <option value="RESOLVED"  {{ 'selected' if status_filter=='RESOLVED' }}>Resolved</option>
          <option value="DISMISSED" {{ 'selected' if status_filter=='DISMISSED' }}>Dismissed</option>
          <option value="ALL"       {{ 'selected' if status_filter=='ALL' }}>All</option>
        </select>
        <noscript><button class="btn btn-outline-dark btn-sm ms-1">Apply</button></noscript>
      </form>
      {% endif %}
    </div>
  </div>

  {% if flags %}
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle table-flags table-sticky">
      <thead class="table-primary text-center">
        <tr>
          <th class="col-when">Flagged At (UTC+8)</th>
          <th class="col-user">Flagged By</th>
          <th class="col-details text-center">Details</th>
          <th class="col-reason">Reason</th>
          <th class="col-status">Status</th>
          <th class="col-view">Session Actions</th>
          <th class="col-act">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for flag in flags %}
        {% set row_class =
            'table-warning' if flag.status=='OPEN' else
            ('table-success' if flag.status=='RESOLVED' else 'table-light') %}
        <tr class="{{ row_class }}">
          <td class="text-muted" style="white-space: nowrap;"><small>{{ flag.flagged_at }}</small></td>
          <td class="text-start">
            <div class="fw-bold">{{ flag.first_name }} {{ flag.last_name }}</div>
            <div class="text-muted small">{{ flag.email }}</div>
          </td>

          <td class="text-center">
            {% if flag.details == "unknown_login" %}
              <span class="badge badge-chip bg-danger">Unknown Login</span>
            {% elif flag.details == "suspicious_activity" %}
              <span class="badge badge-chip bg-warning text-dark">Suspicious Activity</span>
            {% elif flag.details == "unrecognized_actions" %}
              <span class="badge badge-chip bg-primary">Unrecognized Actions</span>
            {% elif flag.details == "other" %}
              <span class="badge badge-chip bg-secondary">Other</span>
            {% else %}
              <span class="badge badge-chip bg-light text-dark">{{ flag.details or '-' }}</span>
            {% endif %}
          </td>

          <td class="col-reason">
            {% if flag.reason %}
              <button type="button" class="btn btn-warning btn-sm btn-chip"
                      data-bs-toggle="collapse" data-bs-target="#reason{{ flag.id }}"
                      aria-expanded="false">View Reason</button>
              <div class="collapse mt-2" id="reason{{ flag.id }}">
                <div class="card card-body text-start bg-light border collapse-card">
                  {{ flag.reason }}
                </div>
              </div>
            {% else %}
              <span class="text-muted">No reason provided</span>
            {% endif %}
          </td>

          <td class="col-status">
            {% if flag.status=='OPEN' %}
              <span class="badge badge-chip bg-warning text-dark">Open</span>
            {% elif flag.status=='RESOLVED' %}
              <span class="badge badge-chip bg-success">Resolved</span>
              {% if flag.resolved_at %}
                <div class="small text-muted mt-1">By {{ flag.resolver_first_name }} {{ flag.resolver_last_name }}<br>{{ flag.resolved_at }}</div>
              {% endif %}
              {% if flag.resolution_note %}
                <div class="badge bg-success-subtle text-dark mt-1">{{ flag.resolution_note }}</div>
              {% endif %}
            {% else %}
              <span class="badge badge-chip bg-secondary">Dismissed</span>
              {% if flag.resolved_at %}
                <div class="small text-muted mt-1">By {{ flag.resolver_first_name }} {{ flag.resolver_last_name }}<br>{{ flag.resolved_at }}</div>
              {% endif %}
              {% if flag.resolution_note %}
                <div class="badge bg-secondary-subtle text-dark mt-1">{{ flag.resolution_note }}</div>
              {% endif %}
            {% endif %}
          </td>

          <td class="col-view">
            <button class="btn btn-outline-dark btn-sm btn-chip"
                    data-bs-toggle="collapse" data-bs-target="#actionsRow{{ flag.id }}"
                    aria-expanded="false">View Actions</button>
          </td>

          <td class="col-act">
            {% if flag.status == 'OPEN' %}
              <div class="d-flex justify-content-center gap-2 flex-wrap">
                <button type="button" class="btn btn-success btn-sm btn-chip"
                        data-bs-toggle="modal" data-bs-target="#resolveModal{{ flag.id }}">Resolve</button>
                <button type="button" class="btn btn-outline-secondary btn-sm btn-chip"
                        data-bs-toggle="modal" data-bs-target="#dismissModal{{ flag.id }}">Dismiss</button>
              </div>
            {% else %}
              <button type="button" class="btn btn-outline-dark btn-sm btn-chip" disabled>Closed</button>
            {% endif %}
          </td>
        </tr>

        <!-- Actions timeline row -->
        <tr class="collapse" id="actionsRow{{ flag.id }}">
          <td colspan="7">
            <div class="accordion" id="accordionFlag{{ flag.id }}">
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ flag.id }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                          data-bs-target="#collapseInner{{ flag.id }}" aria-expanded="false" aria-controls="collapseInner{{ flag.id }}">
                    📝 Actions Timeline
                  </button>
                </h2>
                <div id="collapseInner{{ flag.id }}" class="accordion-collapse collapse"
                     aria-labelledby="heading{{ flag.id }}" data-bs-parent="#accordionFlag{{ flag.id }}">
                  <div class="accordion-body">
                    {% set actions = actions_by_session.get(flag.session_id, []) %}
                    {% if actions %}
                      <table class="table table-sm table-hover align-middle">
                        <thead class="table-light">
                          <tr>
                            <th style="white-space: nowrap;">Timestamp</th>
                            <th>Activity</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for a in actions %}
                          {% set txt = (a.action or '') %}
                          <tr>
                            <td class="text-muted" style="white-space: nowrap;">{{ a.timestamp }}</td>
                            <td class="text-start">
                              {% if 'login' in txt.lower() %}
                                <span class="text-success">🔓 {{ txt }}</span>
                              {% elif 'logout' in txt.lower() %}
                                <span class="text-secondary">🔒 {{ txt }}</span>
                              {% elif 'added to cart' in txt.lower() %}
                                <span class="text-primary">🛒 {{ txt }}</span>
                              {% elif 'deleted' in txt.lower() %}
                                <span class="text-danger">❌ {{ txt }}</span>
                              {% elif 'created' in txt.lower() %}
                                <span class="text-success">🆕 {{ txt }}</span>
                              {% elif 'updated' in txt.lower() or 'changed' in txt.lower() %}
                                <span class="text-info">✏️ {{ txt }}</span>
                              {% else %}
                                {{ txt }}
                              {% endif %}
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    {% else %}
                      <p class="text-muted mb-0">No actions recorded for this session.</p>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>

        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modals outside table -->
  {% for flag in flags %}
  <div class="modal fade" id="resolveModal{{ flag.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('admin_resolve_session_flag', flag_id=flag.id) }}" class="modal-content">
        <div class="modal-header bg-success-subtle">
          <h5 class="modal-title">Resolve Flag #{{ flag.id }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Resolution note (optional)</label>
          <input type="text" name="resolution_note" maxlength="255" class="form-control"
                 placeholder="e.g., Reviewed logs; no suspicious changes found">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success btn-chip">Resolve</button>
          <button type="button" class="btn btn-secondary btn-chip" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="dismissModal{{ flag.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" action="{{ url_for('admin_dismiss_session_flag', flag_id=flag.id) }}" class="modal-content">
        <div class="modal-header bg-secondary-subtle">
          <h5 class="modal-title">Dismiss Flag #{{ flag.id }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Reason for dismissal (optional)</label>
          <input type="text" name="resolution_note" maxlength="255" class="form-control"
                 placeholder="e.g., Duplicate report; already addressed">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-outline-secondary btn-chip">Dismiss</button>
          <button type="button" class="btn btn-secondary btn-chip" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}

  {% else %}
    <div class="alert alert-warning text-center mt-4">No session flags found.</div>
  {% endif %}

  <div class="text-center my-4">
    <a href="{{ url_for('activity_history') }}" class="btn btn-secondary btn-chip">Back to Session History</a>
  </div>
</div>

{% if email_prompt %}
<div class="modal fade" id="emailNotifyModal" tabindex="-1" aria-labelledby="emailNotifyLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('admin_notify_flagger', flag_id=email_prompt.flag_id) }}" class="modal-content">
      <div class="modal-header bg-info-subtle">
        <h5 class="modal-title" id="emailNotifyLabel">
          Email user about {{ email_prompt.status|lower|capitalize }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">To</label>
          <input class="form-control" value="{{ email_prompt.user_email }}" readonly>
          <div class="form-text">Recipient: {{ email_prompt.user_name }}</div>
        </div>
        <div class="mb-2">
          <label class="form-label">Subject</label>
          <input class="form-control" name="subject"
                 value="Update: Your flagged session was {{ email_prompt.status|lower }}">
        </div>
        <div class="mb-2">
          <label class="form-label">Message</label>
          <textarea class="form-control" name="message" rows="6">{% filter trim %}
Hi {{ email_prompt.user_name }},

Thanks for reporting your recent session.

Status: {{ email_prompt.status|lower|capitalize }}
Flagged at: {{ email_prompt.flagged_at }}
Category: {{ email_prompt.details|replace('_',' ')|title }}
{% if email_prompt.reason %}Your note: {{ email_prompt.reason }}{% endif %}

If anything still looks off, reply to this email and we'll take another look.

- Admin Team
{% endfilter %}</textarea>
          <div class="form-text">Feel free to edit before sending.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary btn-chip">Send Email</button>
        <button type="button" class="btn btn-secondary btn-chip" data-bs-dismiss="modal">Close</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var m = new bootstrap.Modal(document.getElementById('emailNotifyModal'));
    m.show();
  });
</script>
{% endif %}

{% endblock %}
