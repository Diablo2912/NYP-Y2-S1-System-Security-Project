{% extends "base.html" %}

{% block content %}
{% from "includes/_formHelper.html" import render_field %}

{# Flash messages #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="py-4 py-lg-5">
  <div class="container">
    <div class="row justify-content-center">
      <!-- wider overall: spans ~11/12 at xxl -->
      <div class="col-12 col-xl-11 col-xxl-11">
        <div class="card border-0 shadow rounded-4 overflow-hidden">
          <div class="row g-0 align-items-stretch" style="min-height: 460px;">

            <!-- LEFT: wide image panel (rectangle look) -->
            <div class="col-lg-7 d-none d-md-block position-relative"
                 style="background:
                        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55)),
                        url('{{ url_for('static', filename='assets/crops-growing-in-thailand.jpg') }}') center/cover no-repeat;">
              <div class="position-absolute bottom-0 start-0 end-0 p-4 text-white">
                <span class="badge bg-success rounded-pill mb-2">Cropzy</span>
                <h2 class="h5 fw-semibold mb-1">Welcome back</h2>
                <p class="small text-white-50 mb-0">Sign in to continue your session.</p>
              </div>
            </div>

            <!-- RIGHT: compact form on soft canvas -->
            <div class="col-lg-5 bg-body-tertiary d-flex">
              <div class="p-4 p-lg-5 flex-grow-1">
                <h1 class="h4 fw-bold text-center mb-1">Login</h1>
                <p id="timer-container" class="text-center text-muted small mb-4">
                  ⏳ This form will auto-destruct in <span id="countdown">300</span> seconds.
                </p>

                <form
                  id="autoDestructForm"
                  method="POST"
                  action="{{ url_for('login', next=request.args.get('next') or session.get('post_login_next')) }}"
                  class="needs-validation"
                  novalidate
                  autocomplete="off"
                >
                  {{ form.hidden_tag() }}
                  <input type="hidden" name="next" value="{{ request.args.get('next') or session.get('post_login_next') or '' }}">

                  <!-- Email -->
                  <div class="mb-3">
                    {{ render_field(form.email, class="form-control", autocomplete="off") }}
                  </div>

                  <!-- Password + toggle -->
                  <div class="mb-3">
                    {{ form.pswd.label(class="form-label") }}
                    <div class="input-group">
                      {{ form.pswd(class="form-control", id="loginPassword", autocomplete="off") }}
                      <button type="button" class="btn btn-outline-secondary" id="togglePassword" aria-label="Show password">
                        <i id="eyeIcon" class="fa fa-eye"></i>
                      </button>
                    </div>
                  </div>

                  <!-- reCAPTCHA -->
                  <div class="mb-3">
                    <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
                  </div>

                  <!-- Divider -->
                  <div class="d-flex align-items-center my-3">
                    <hr class="flex-grow-1">
                    <span class="px-2 text-muted small">or</span>
                    <hr class="flex-grow-1">
                  </div>

                  <!-- Google -->
                  <a class="btn btn-outline-dark w-100 mb-2 d-flex align-items-center justify-content-center gap-2"
                     href="{{ url_for('login_google') }}">
                    <img src="https://developers.google.com/identity/images/g-logo.png" alt="" style="height:18px;">
                    <span>Sign in with Google</span>
                  </a>

                  <!-- Submit -->
                  <button type="submit" class="btn btn-success w-100">Login</button>

                  <!-- Help -->
                  <p class="text-center mt-3 mb-0 small">
                    Forgot your password? Reset <a href="{{ url_for('reset_password_request') }}">here</a>
                  </p>
                </form>
              </div>
            </div>

          </div> <!-- /row -->
        </div>   <!-- /card -->
      </div>
    </div>
  </div>
</section>

<!-- Page scripts -->
<script>
  // password toggle
  document.getElementById('togglePassword')?.addEventListener('click', function() {
    const input = document.getElementById('loginPassword');
    const icon  = document.getElementById('eyeIcon');
    if (!input) return;
    const isPwd = input.type === 'password';
    input.type = isPwd ? 'text' : 'password';
    icon.classList.toggle('fa-eye', !isPwd);
    icon.classList.toggle('fa-eye-slash', isPwd);
  });

  // auto-destruct timer
  (function () {
    let secondsLeft = 300;
    const countdownEl = document.getElementById('countdown');
    const form = document.getElementById('autoDestructForm');
    const timer = setInterval(() => {
      secondsLeft--;
      if (countdownEl) countdownEl.textContent = secondsLeft;
      if (secondsLeft <= 0) {
        clearInterval(timer);
        if (form) Array.from(form.elements).forEach(el => el.disabled = true);
        const tc = document.getElementById('timer-container');
        if (tc) tc.innerHTML = "<strong>⛔ Time's up! Form disabled.</strong>";
      }
    }, 1000);
  })();
</script>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
