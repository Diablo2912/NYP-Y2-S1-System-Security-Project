{% extends "base.html" %}

{% block content %}
{% from "includes/_formHelper.html" import render_field %}

{# Flash messages #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="py-4 py-lg-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-11">
        <div class="card border-0 shadow rounded-4 overflow-hidden">
          <div class="row g-0 align-items-stretch" style="min-height: 520px;">

            <!-- LEFT: image panel -->
            <div class="col-lg-7 d-none d-md-block position-relative"
                 style="background:
                        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.45)),
                        url('{{ url_for('static', filename='assets/crops-growing-in-thailand.jpg') }}') center/cover no-repeat;">
              <div class="position-absolute bottom-0 start-0 end-0 p-4 text-white">
                <span class="badge bg-success rounded-pill mb-2">Cropzy</span>
                <h2 class="h5 fw-semibold mb-1">Create your account</h2>
                <p class="small text-white-50 mb-0">Join us to cultivate smarter.</p>
              </div>
            </div>

            <!-- RIGHT: form -->
            <div class="col-lg-5 bg-body-tertiary d-flex">
              <div class="p-4 p-lg-5 w-100">
                <h1 class="h4 fw-bold text-center mb-3">Sign Up</h1>

                <!-- Continue with Google -->
                <a class="btn btn-outline-dark w-100 mb-3 d-flex align-items-center justify-content-center gap-2"
                   href="{{ url_for('login_google') }}">
                  <img src="https://developers.google.com/identity/images/g-logo.png" alt="" style="height:18px;">
                  <span>Continue with Google</span>
                </a>

                <div class="d-flex align-items-center my-3">
                  <hr class="flex-grow-1">
                  <span class="px-2 text-muted small">or</span>
                  <hr class="flex-grow-1">
                </div>

                <form id="autoDestructForm" method="POST" action="" class="row g-3 needs-validation" novalidate autocomplete="off">
                  {{ form.hidden_tag() }}

                  <!-- Names -->
                  <div class="col-md-6">
                    {{ render_field(form.first_name, class="form-control", id="firstName", minlength="2", required=true) }}
                    <div class="invalid-feedback">Enter at least 2 letters.</div>
                  </div>
                  <div class="col-md-6">
                    {{ render_field(form.last_name, class="form-control", id="lastName", minlength="2", required=true) }}
                    <div class="invalid-feedback">Enter at least 2 letters.</div>
                  </div>

                  <!-- Gender & Phone -->
                  <div class="col-md-6">
                    {{ render_field(form.gender, class="form-select", id="gender", required=true) }}
                    <div class="invalid-feedback">Please select your gender.</div>
                  </div>
                  <div class="col-md-6">
                    {{ render_field(form.number, class="form-control", id="phone", inputmode="numeric", pattern="^[0-9]{8,15}$", required=true, placeholder="Digits only") }}
                    <div class="invalid-feedback">Phone must be 8–15 digits.</div>
                  </div>

                  <!-- Email -->
                  <div class="col-12">
                    {{ render_field(form.email, class="form-control", id="email", type="email", required=true) }}
                    <div class="invalid-feedback">Enter a valid email address.</div>
                  </div>

                  <!-- Password -->
                  <div class="col-12">
                    {{ form.pswd.label(class="form-label") }}
                    <div class="input-group">
                      {{ form.pswd(class="form-control", id="signupPassword", autocomplete="new-password", required=true, minlength="8") }}
                      <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('signupPassword','iconSignupPwd')" aria-label="Show password">
                        <i id="iconSignupPwd" class="fa fa-eye"></i>
                      </button>
                      <div class="invalid-feedback">Please meet the password requirements below.</div>
                    </div>

                    <!-- Strength checklist -->
                    <ul class="small text-muted mt-2 mb-0" id="pwdChecklist">
                      <li id="req-length">• At least 8 characters</li>
                      <li id="req-upper">• At least 1 uppercase (A–Z)</li>
                      <li id="req-lower">• At least 1 lowercase (a–z)</li>
                      <li id="req-number">• At least 1 number (0–9)</li>
                      <li id="req-symbol">• At least 1 symbol (!@#$…)</li>
                    </ul>
                  </div>

                  <!-- Confirm Password -->
                  <div class="col-12">
                    {{ form.cfm_pswd.label(class="form-label") }}
                    <div class="input-group">
                      {{ form.cfm_pswd(class="form-control", id="signupConfirmPassword", autocomplete="new-password", required=true) }}
                      <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('signupConfirmPassword','iconSignupConfirm')" aria-label="Show password">
                        <i id="iconSignupConfirm" class="fa fa-eye"></i>
                      </button>
                      <div class="invalid-feedback">Passwords must match.</div>
                    </div>
                    <div id="matchHint" class="form-text"></div>
                  </div>

                  <!-- Timer -->
                  <div class="col-12">
                    <p id="timer-container" class="text-muted small mb-0">
                      ⏳ This form will auto-destruct in <span id="countdown">300</span> seconds.
                    </p>
                  </div>

                  <!-- reCAPTCHA -->
                  <div class="col-12">
                    <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
                  </div>

                  <div class="col-12">
                    <button type="submit" class="btn btn-success w-100 mt-2">Submit</button>
                  </div>
                </form>
              </div>
            </div>

          </div> <!-- /row -->
        </div>   <!-- /card -->
      </div>
    </div>
  </div>
</section>

<script>
  // Toggle helpers
  function togglePassword(inputId, iconId) {
    const input = document.getElementById(inputId);
    const icon  = document.getElementById(iconId);
    if (!input || !icon) return;
    const isPwd = input.type === "password";
    input.type = isPwd ? "text" : "password";
    icon.classList.toggle("fa-eye", !isPwd);
    icon.classList.toggle("fa-eye-slash", isPwd);
  }

  // Basic validators
  const el = (id) => document.getElementById(id);

  const firstName = el('firstName');
  const lastName  = el('lastName');
  const gender    = el('gender');
  const phone     = el('phone');
  const email     = el('email');
  const pwd       = el('signupPassword');
  const cfm       = el('signupConfirmPassword');

  const reqLen    = el('req-length');
  const reqUp     = el('req-upper');
  const reqLow    = el('req-lower');
  const reqNum    = el('req-number');
  const reqSym    = el('req-symbol');
  const matchHint = el('matchHint');

  // helper to set checklist item state
  function setItem(el, ok) {
    if (!el) return;
    el.classList.toggle('text-success', ok);
    el.classList.toggle('text-danger', !ok);
  }

  function validateName(input) {
    if (!input) return true;
    const ok = /^[A-Za-z][A-Za-z .'-]{1,}$/.test(input.value.trim());
    input.classList.toggle('is-valid', ok);
    input.classList.toggle('is-invalid', !ok);
    return ok;
  }

  function validatePhone() {
    if (!phone) return true;
    const ok = /^[0-9]{8,15}$/.test(phone.value.trim());
    phone.classList.toggle('is-valid', ok);
    phone.classList.toggle('is-invalid', !ok);
    return ok;
  }

  function validateEmail() {
    if (!email) return true;
    const ok = email.checkValidity();
    email.classList.toggle('is-valid', ok);
    email.classList.toggle('is-invalid', !ok);
    return ok;
  }

  function validateGender() {
    if (!gender) return true;
    const ok = !!gender.value;
    gender.classList.toggle('is-valid', ok);
    gender.classList.toggle('is-invalid', !ok);
    return ok;
  }

  function validatePassword() {
    if (!pwd) return true;
    const v = pwd.value;
    const okLen = v.length >= 8;
    const okUp  = /[A-Z]/.test(v);
    const okLo  = /[a-z]/.test(v);
    const okNum = /[0-9]/.test(v);
    const okSym = /[^A-Za-z0-9]/.test(v);

    setItem(reqLen, okLen);
    setItem(reqUp,  okUp);
    setItem(reqLow, okLo);
    setItem(reqNum, okNum);
    setItem(reqSym, okSym);

    const ok = okLen && okUp && okLo && okNum && okSym;
    pwd.classList.toggle('is-valid', ok);
    pwd.classList.toggle('is-invalid', !ok && v.length > 0);
    return ok;
  }

  function validateConfirm() {
    if (!pwd || !cfm) return true;
    const same = pwd.value === cfm.value && cfm.value.length > 0;
    matchHint.textContent = cfm.value.length ? (same ? 'Passwords match.' : 'Passwords do not match.') : '';
    matchHint.classList.toggle('text-success', same);
    matchHint.classList.toggle('text-danger', !same && cfm.value.length > 0);
    cfm.classList.toggle('is-valid', same);
    cfm.classList.toggle('is-invalid', !same && cfm.value.length > 0);
    return same;
  }

  // bind live events
  firstName?.addEventListener('input', () => validateName(firstName));
  lastName?.addEventListener('input',  () => validateName(lastName));
  phone?.addEventListener('input',     validatePhone);
  email?.addEventListener('input',     validateEmail);
  gender?.addEventListener('change',   validateGender);
  pwd?.addEventListener('input',       () => { validatePassword(); validateConfirm(); });
  cfm?.addEventListener('input',       validateConfirm);

  // submit gate
  document.getElementById('autoDestructForm')?.addEventListener('submit', function(e) {
    const allOk = [
      validateName(firstName),
      validateName(lastName),
      validateGender(),
      validatePhone(),
      validateEmail(),
      validatePassword(),
      validateConfirm()
    ].every(Boolean);

    if (!allOk) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.add('was-validated');
      // focus first invalid
      const firstInvalid = this.querySelector('.is-invalid');
      if (firstInvalid) firstInvalid.focus();
    }
  });

  // 5-minute countdown (disables form on expiry)
  (function () {
    let secondsLeft = 300;
    const countdownEl = document.getElementById('countdown');
    const form = document.getElementById('autoDestructForm');
    const timer = setInterval(() => {
      secondsLeft--;
      if (countdownEl) countdownEl.textContent = secondsLeft;
      if (secondsLeft <= 0) {
        clearInterval(timer);
        if (form) Array.from(form.elements).forEach(el => el.disabled = true);
        const tc = document.getElementById('timer-container');
        if (tc) tc.innerHTML = "<strong>⛔ Time's up! Form disabled.</strong>";
      }
    }, 1000);
  })();
</script>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
