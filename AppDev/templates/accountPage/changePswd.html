{% extends "base.html" %}
{% block content %}
{% from "includes/_formHelper.html" import render_field %}

{# flashes #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<section class="py-4 py-lg-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-11">
        <div class="card border-0 shadow rounded-4 overflow-hidden">
          <div class="row g-0 align-items-stretch" style="min-height: 420px;">

            <!-- Left image -->
            <div class="col-lg-7 d-none d-md-block position-relative"
                 style="background:
                        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.45)),
                        url('{{ url_for('static', filename='assets/crops-growing-in-thailand.jpg') }}') center/cover no-repeat;">
              <div class="position-absolute bottom-0 start-0 end-0 p-4 text-white">
                <span class="badge bg-success rounded-pill mb-2">Cropzy</span>
                <h2 class="h5 fw-semibold mb-1">Change your password</h2>
                <p class="small text-white-50 mb-0">Keep your account secure with a strong passphrase.</p>
              </div>
            </div>

            <!-- Right form -->
            <div class="col-lg-5 bg-body-tertiary d-flex">
              <div class="p-4 p-lg-5 w-100">
                <h1 class="h4 fw-bold text-center mb-3">Change Password</h1>

                <form method="POST" action="" id="changePwdForm" class="needs-validation" novalidate autocomplete="off">
                  {{ form.hidden_tag() }}

                  <!-- Current -->
                  <div class="mb-3">
                    {{ form.current_pswd.label(class="form-label") }}
                    <div class="input-group">
                      {{ form.current_pswd(class="form-control", id="currentPwd", minlength="8", required=true, autocomplete="current-password") }}
                      <button type="button" class="btn btn-outline-secondary" id="toggleCurrent" aria-label="Show password">
                        <i id="iconCurrent" class="fa fa-eye"></i>
                      </button>
                      <div class="invalid-feedback">Please enter your current password (min 8 chars).</div>
                    </div>
                  </div>

                  <!-- New -->
                  <div class="mb-3">
                    {{ form.new_pswd.label(class="form-label") }}
                    <div class="input-group">
                      {{ form.new_pswd(class="form-control", id="newPwd", required=true, minlength="8", autocomplete="new-password") }}
                      <button type="button" class="btn btn-outline-secondary" id="toggleNew" aria-label="Show password">
                        <i id="iconNew" class="fa fa-eye"></i>
                      </button>
                      <div class="invalid-feedback">Please meet the requirements below.</div>
                    </div>

                    <!-- strength checklist -->
                    <ul class="small text-muted mt-2 mb-0" id="pwdChecklist">
                      <li id="req-length">• At least 8 characters</li>
                      <li id="req-upper">• At least 1 uppercase (A–Z)</li>
                      <li id="req-lower">• At least 1 lowercase (a–z)</li>
                      <li id="req-number">• At least 1 number (0–9)</li>
                      <li id="req-symbol">• At least 1 symbol (!@#$…)</li>
                    </ul>
                    <div id="reuseHint" class="form-text"></div>
                  </div>

                  <!-- Confirm -->
                  <div class="mb-3">
                    {{ form.confirm_pswd.label(class="form-label") }}
                    <div class="input-group">
                      {{ form.confirm_pswd(class="form-control", id="confirmPwd", required=true, autocomplete="new-password") }}
                      <button type="button" class="btn btn-outline-secondary" id="toggleConfirm" aria-label="Show password">
                        <i id="iconConfirm" class="fa fa-eye"></i>
                      </button>
                      <div class="invalid-feedback">Passwords must match.</div>
                    </div>
                    <div id="matchHint" class="form-text"></div>
                  </div>

                  <button type="submit" class="btn btn-success w-100">Submit</button>
                </form>
              </div>
            </div>

          </div><!--/row-->
        </div>
      </div>
    </div>
  </div>
</section>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
  // eye toggles
  function bindToggle(btnId, inputId, iconId){
    const btn=document.getElementById(btnId), input=document.getElementById(inputId), icon=document.getElementById(iconId);
    if(!btn||!input||!icon) return;
    btn.addEventListener('click', ()=> {
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      icon.classList.toggle('fa-eye', !isPwd);
      icon.classList.toggle('fa-eye-slash', isPwd);
    });
  }
  bindToggle('toggleCurrent','currentPwd','iconCurrent');
  bindToggle('toggleNew','newPwd','iconNew');
  bindToggle('toggleConfirm','confirmPwd','iconConfirm');

  // live validators
  (function(){
    const form = document.getElementById('changePwdForm');
    const current = document.getElementById('currentPwd');
    const pwd = document.getElementById('newPwd');
    const cfm = document.getElementById('confirmPwd');

    const reqLen = document.getElementById('req-length');
    const reqUp  = document.getElementById('req-upper');
    const reqLo  = document.getElementById('req-lower');
    const reqNum = document.getElementById('req-number');
    const reqSym = document.getElementById('req-symbol');
    const matchHint = document.getElementById('matchHint');
    const reuseHint = document.getElementById('reuseHint');

    const setItem = (el, ok) => { if(!el) return; el.classList.toggle('text-success', ok); el.classList.toggle('text-danger', !ok); };

    function validateCurrent(){
      const ok = current.value.length >= 8;
      current.classList.toggle('is-valid', ok);
      current.classList.toggle('is-invalid', !ok && current.value.length>0);
      return ok;
    }

    function validatePassword(){
      const v = pwd.value;
      const okLen = v.length >= 8;
      const okUp  = /[A-Z]/.test(v);
      const okLo  = /[a-z]/.test(v);
      const okNum = /[0-9]/.test(v);
      const okSym = /[^A-Za-z0-9]/.test(v);

      setItem(reqLen, okLen); setItem(reqUp, okUp); setItem(reqLo, okLo); setItem(reqNum, okNum); setItem(reqSym, okSym);

      const ok = okLen && okUp && okLo && okNum && okSym;
      pwd.classList.toggle('is-valid', ok);
      pwd.classList.toggle('is-invalid', !ok && v.length>0);

      // non-blocking reuse warning
      if (reuseHint) {
        const same = v && current.value && v === current.value;
        reuseHint.textContent = same ? 'New password is the same as your current password.' : '';
        reuseHint.classList.toggle('text-danger', same);
      }
      return ok;
    }

    function validateConfirm(){
      const same = pwd.value === cfm.value && cfm.value.length>0;
      cfm.classList.toggle('is-valid', same);
      cfm.classList.toggle('is-invalid', !same && cfm.value.length>0);
      if (matchHint) {
        matchHint.textContent = cfm.value.length ? (same ? 'Passwords match.' : 'Passwords do not match.') : '';
        matchHint.classList.toggle('text-success', same);
        matchHint.classList.toggle('text-danger', !same && cfm.value.length>0);
      }
      return same;
    }

    current?.addEventListener('input', () => { validateCurrent(); validatePassword(); });
    pwd?.addEventListener('input', () => { validatePassword(); validateConfirm(); });
    cfm?.addEventListener('input',  validateConfirm);

    form?.addEventListener('submit', function(e){
      const allOk = [validateCurrent(), validatePassword(), validateConfirm()].every(Boolean);
      if (!allOk) {
        e.preventDefault(); e.stopPropagation();
        this.classList.add('was-validated');
        const firstInvalid = this.querySelector('.is-invalid');
        if (firstInvalid) firstInvalid.focus();
      }
    });
  })();
</script>
{% endblock %}
