{% extends "base.html" %}
{% block title %}Create Product{% endblock %}

{% block content %}
{% from "includes/_formHelper.html" import render_field %}

<style>
  /* Light green form look + focus ring to match the rest of the app */
  .cz-form-card{background:#eaf6ef;}
  .cz-form-card .form-control:focus,
  .cz-form-card .form-select:focus{
    border-color:#198754;
    box-shadow:0 0 0 .25rem rgba(25,135,84,.15);
  }
  .cz-form-card .btn-success{background:#198754;border-color:#198754;}

  /* Image drop area */
  .cz-drop{
    border:2px dashed rgba(25,135,84,.35);
    background:#f7fbf8;
    border-radius:1rem;
    padding:1rem;
    text-align:center;
    transition:.2s ease-in-out;
    cursor:pointer;
  }
  .cz-drop.dragover{background:#eef7f1;border-color:#198754;}
  .cz-thumb{
    width:100%; max-height:240px; object-fit:contain; display:none;
    border-radius:.75rem;
  }
  .cz-file-hint{font-size:.9rem;color:#6c757d}
</style>

<section class="py-4 py-lg-5">
  <div class="container">
    <h1 class="text-center fw-bold text-success mb-3">Create a New Product</h1>

    <div class="card shadow border-0 rounded-4 cz-form-card">
      <div class="card-body p-4 p-lg-5">
        <form id="createProductForm" method="POST" action="" enctype="multipart/form-data" novalidate>
          {{ form.hidden_tag() }}

          <div class="row g-4">
            <!-- Left: image uploader -->
            <div class="col-lg-5">
              <label class="form-label fw-semibold mb-2">Product Image</label>

              <!-- Drop/Click area -->
              <div id="dropArea" class="cz-drop">
                <img id="previewImg" class="cz-thumb mb-2" alt="Preview">
                <div id="dropText" class="cz-file-hint">
                  Drag &amp; drop an image here, or click to browse.
                  <br>PNG/JPG up to 2&nbsp;MB.
                </div>
              </div>

              <!-- The actual input (kept as your original field) -->
              {{ form.product_image(id="product_image", class="form-control mt-2", accept="image/*") }}
              <div class="invalid-feedback">Only JPG/PNG up to 2&nbsp;MB.</div>
            </div>

            <!-- Right: fields -->
            <div class="col-lg-7">
              <div class="row g-3">
                <!-- Product name -->
                <div class="col-12">
                  <label for="product_name" class="form-label">Product Name</label>
                  {{ form.product_name(
                      id="product_name",
                      class="form-control",
                      minlength="1",
                      maxlength="150",
                      pattern="^[A-Za-z0-9][A-Za-z0-9 \-_'’(),.&/]{0,149}$",
                      placeholder="e.g. Organic Wheat Seeds",
                      required=True
                  ) }}
                  <div class="invalid-feedback">1–150 chars. Letters/numbers/spaces and - _ ’ ( ) , . &amp; / allowed.</div>
                </div>

                <!-- Category + Quantity -->
                <div class="col-md-6">
                  <label for="category" class="form-label">Category</label>
                  {{ form.category(id="category", class="form-select", required=True) }}
                  <div class="invalid-feedback">Please select a category.</div>
                </div>
                <div class="col-md-6">
                  <label for="quantity" class="form-label">Quantity</label>
                  {{ form.quantity(
                      id="quantity",
                      class="form-control",
                      type="number",
                      min="0",
                      step="1",
                      placeholder="e.g. 10",
                      required=True
                  ) }}
                  <div class="invalid-feedback">Quantity must be 0 or more.</div>
                </div>

                <!-- Price + CO2 -->
                <div class="col-md-6">
                  <label for="price" class="form-label">Price ($)</label>
                  {{ form.price(
                      id="price",
                      class="form-control",
                      type="number",
                      min="0",
                      step="0.01",
                      placeholder="e.g. 10.00",
                      required=True
                  ) }}
                  <div class="invalid-feedback">Enter a non-negative amount with ≤ 2 decimal places.</div>
                </div>
                <div class="col-md-6">
                  <label for="co2" class="form-label">CO₂ Emissions (kg)</label>
                  {{ form.co2(
                      id="co2",
                      class="form-control",
                      type="number",
                      min="0",
                      step="0.01",
                      placeholder="e.g. 2.5"
                  ) }}
                  <div class="invalid-feedback">Must be 0 or more (≤ 2 decimal places).</div>
                </div>

                <!-- Description -->
                <div class="col-12">
                  <label for="product_description" class="form-label">Product Description</label>
                  {{ form.product_description(
                      id="product_description",
                      class="form-control",
                      rows="4",
                      maxlength="1000",
                      placeholder="Provide details about the product"
                  ) }}
                  <div class="form-text"><span id="descCount">{{ form.product_description.data|length if form.product_description.data else 0 }}</span>/1000</div>
                </div>

                <!-- Captcha -->
                <div class="col-12">
                  <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
                </div>

                <!-- Submit -->
                <div class="col-12">
                  <button type="submit" class="btn btn-success w-100">Create Product</button>
                </div>
              </div>
            </div>
          </div>
        </form>

        <!-- action links -->
        <div class="text-center mt-4">
          <a href="{{ url_for('manageProduct') }}" class="btn btn-outline-secondary me-2">Manage Products</a>
          <a href="{{ url_for('buy_product') }}" class="btn btn-outline-primary">Back to Shop</a>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
(function () {
  const form = document.getElementById('createProductForm');
  const fields = ['product_image','product_name','quantity','category','price','co2','product_description']
    .map(id => document.getElementById(id)).filter(Boolean);

  // --- Image preview + file guards ---
  const imgInput  = document.getElementById('product_image');
  const dropArea  = document.getElementById('dropArea');
  const preview   = document.getElementById('previewImg');
  const dropText  = document.getElementById('dropText');

  function applyImgValidity(ok){
    toggleState(imgInput, ok);
    if (!ok) {
      preview.style.display = 'none';
      dropText.style.display = '';
    }
  }

  function handleFiles(file){
    if (!file){ applyImgValidity(true); return; }
    const okType = /image\/(jpeg|jpg|png)/i.test(file.type);
    const okSize = file.size <= 2 * 1024 * 1024;
    const ok = okType && okSize;
    applyImgValidity(ok);
    if (ok){
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = 'block';
        dropText.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }
  }

  if (imgInput){
    imgInput.addEventListener('change', () => handleFiles(imgInput.files && imgInput.files[0]));
  }

  if (dropArea){
    dropArea.addEventListener('click', () => imgInput && imgInput.click());
    ['dragenter','dragover'].forEach(ev => dropArea.addEventListener(ev, e=>{
      e.preventDefault(); e.stopPropagation(); dropArea.classList.add('dragover');
    }));
    ['dragleave','drop'].forEach(ev => dropArea.addEventListener(ev, e=>{
      e.preventDefault(); e.stopPropagation(); dropArea.classList.remove('dragover');
    }));
    dropArea.addEventListener('drop', e=>{
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (imgInput && file){
        imgInput.files = e.dataTransfer.files;  // reflect to input for form submit
        handleFiles(file);
      }
    });
  }

  // --- Helpers ---
  function toggleState(el, pass = null) {
    const isValid = (pass === null) ? el.checkValidity() : pass;
    const hasValue =
      el.type === 'file' ? (el.files && el.files.length > 0) : String(el.value).trim() !== '';
    el.classList.toggle('is-valid', isValid && hasValue);
    el.classList.toggle('is-invalid', !isValid && (hasValue || el.required));
  }

  // Live validation
  fields.forEach(el => {
    const evt = (el.tagName === 'SELECT') ? 'change' : 'input';
    el.addEventListener(evt, () => toggleState(el));
    el.addEventListener('blur', () => toggleState(el));
  });

  // Price & CO2 clamp to ≤ 2 dp visually
  ['price','co2'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('change', ()=>{
      if (el.value) {
        const n = Number(el.value);
        if (!Number.isNaN(n)) {
          const dp = (el.value.split('.')[1] || '').length;
          el.value = n.toFixed(Math.min(2, dp));
        }
      }
      toggleState(el);
    });
  });

  // Description counter
  const desc = document.getElementById('product_description');
  const descCount = document.getElementById('descCount');
  if (desc && descCount){
    desc.addEventListener('input', ()=>{ descCount.textContent = desc.value.length; });
  }

  // Final gate
  form.addEventListener('submit', function (e) {
    fields.forEach(el => toggleState(el));
    if (imgInput && imgInput.files && imgInput.files[0]) {
      const f = imgInput.files[0];
      const okType = /image\/(jpeg|jpg|png)/i.test(f.type);
      const okSize = f.size <= 2 * 1024 * 1024;
      if (!(okType && okSize)) toggleState(imgInput, false);
    }
    if (!form.checkValidity()) {
      e.preventDefault(); e.stopPropagation();
    }
    form.classList.add('was-validated');
  });
})();
</script>

<script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}
