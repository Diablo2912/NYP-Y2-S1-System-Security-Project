{% extends "base.html" %}
{% block content %}

<!-- Clean, modern styling â€” UI only (no logic changed) -->
<style>
  /* page spacing */
  .products-page-title{letter-spacing:.3px}

  /* wider gutters between cards */
  .row.g-4{ --bs-gutter-x:1.5rem; --bs-gutter-y:1.5rem; }

  /* product cards */
  .product-card{
    border:1px solid rgba(0,0,0,.05);
    border-radius:18px;
    box-shadow:0 6px 18px rgba(0,0,0,.06);
    transition:transform .18s ease, box-shadow .18s ease;
    overflow:hidden;
    display:flex;            /* for sticky footer */
    flex-direction:column;
  }
  .product-card:hover{
    transform:translateY(-3px);
    box-shadow:0 10px 26px rgba(0,0,0,.1);
  }

  /* image area */
  .img-wrap{
    height:240px;                       /* more breathing room */
    background:#f6f7f9;
    display:flex; align-items:center; justify-content:center;
    padding:16px;
  }
  .img-wrap img{ max-height:220px; object-fit:contain; }

  /* body */
  .product-card .card-body{ padding:1.25rem 1.25rem .5rem; }
  .product-card .card-title{
    margin-bottom:.35rem; line-height:1.25;
    min-height:2.5rem;                   /* consistent two-line title */
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }
  .meta{ color:#6c757d; margin:.15rem 0; }

  .price-badge{
    display:inline-flex; align-items:center; gap:.35rem;
    background:#e8f5ee; color:#198754;
    border:1px solid rgba(25,135,84,.25);
    padding:.35rem .75rem; border-radius:999px; font-weight:700;
    margin-top:.4rem;
  }

  /* footer button aligned across cards */
  .product-card .card-footer{
    background:#fff; border:0;
    padding:1rem 1.25rem 1.25rem;
    margin-top:auto;                     /* push footer to bottom */
  }

  /* offcanvas: a bit wider on desktop */
  @media (min-width: 992px){
    .offcanvas-end{ width: 420px; }
  }

  /* responsive image height */
  @media (max-width: 991.98px){ .img-wrap{height:200px;} .img-wrap img{max-height:185px;} }
  @media (max-width: 575.98px){ .img-wrap{height:170px;} .img-wrap img{max-height:155px;} }
</style>

<div class="container my-4">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
    <h1 class="products-page-title mb-0">Products</h1>

    <!-- Sidebar Cart Button -->
    <button class="btn btn-outline-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#cartSidebar">
      ðŸ›’ View Cart
    </button>
  </div>

  <!-- Bootstrap Offcanvas Sidebar Cart -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartSidebar">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title text-success">Your Cart</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      {% if session['cart'] %}
        <ul class="list-group">
          {% for product_id, item in session['cart'].items() %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <img src="{{ item.image }}" width="50" height="50" class="rounded object-fit-contain" alt="{{ item.name }}">
            <div class="text-end ms-2">
              <h6 class="mb-0">{{ item.name }}</h6>
              <small>${{ item.price }} Ã— {{ item.quantity }}</small>
            </div>
          </li>
          {% endfor %}
        </ul>

        <div class="text-end mt-3">
          <h5 class="text-success">Total: ${{ "%.2f"|format(total_price) }}</h5>
        </div>

        <form action="{{ url_for('clear_cart') }}" method="POST" class="mt-3">
          <button type="submit" class="btn btn-danger w-100">Clear Cart</button>
        </form>

        <a href="{{ url_for('checkout') }}" class="btn btn-primary w-100 mt-2">Checkout</a>
      {% else %}
        <p class="text-center text-danger">Your cart is empty!</p>
      {% endif %}
    </div>
  </div>

  <!-- Featured Products -->
  <div class="row g-4 mt-4 mb-2">
    <div class="col-12">
      <h2 class="text-center">Featured Products</h2>
    </div>

    {% for product in products[:3] %}
    <div class="col-md-6 col-lg-4">
      <div class="card product-card h-100">
        <div class="img-wrap">
          <img
            src="{{ url_for('static', filename='uploads/' + (product.image_filename or 'default.jpg')) }}"
            alt="{{ product.name }}"
            class="img-fluid">
        </div>

        <div class="card-body">
          <h5 class="card-title">{{ product.name }}</h5>
          <div class="meta">Quantity: <strong>{{ product.quantity }}</strong></div>
          <div class="meta">Category: <span class="fw-semibold">{{ product.category }}</span></div>
          <div><span class="price-badge">$ {{ "%.2f"|format(product.price) }}</span></div>
        </div>

        <div class="card-footer">
          <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="POST">
            <button type="submit" class="btn btn-success w-100">Add to Cart</button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="row mt-3">
    <!-- Filter Section -->
    <div class="col-lg-3 mb-4">
      <button class="btn btn-secondary w-100 mb-3" data-bs-toggle="collapse" data-bs-target="#filter-section">
        FILTER
      </button>

      <div id="filter-section" class="collapse">
        <div class="card p-3">
          <form method="GET" action="{{ url_for('buy_product') }}">
            <div class="mb-3">
              <h5 class="mb-2">Product Category</h5>
              {% for category in all_categories %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="category" value="{{ category }}" id="{{ category }}"
                         {% if category in selected_categories %}checked{% endif %}>
                  <label class="form-check-label" for="{{ category }}">{{ category }}</label>
                </div>
              {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary w-100">Apply Filter</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Full Product List -->
    <div class="col-lg-9">
      <div class="row g-4">
        {% for product in products %}
        <div class="col-sm-6 col-lg-4">
          <div class="card product-card h-100">
            <div class="img-wrap">
              <img
                src="{{ url_for('static', filename='uploads/' + (product.image_filename or 'default.jpg')) }}"
                alt="{{ product.name }}"
                class="img-fluid">
            </div>

            <div class="card-body">
              <h5 class="card-title">{{ product.name }}</h5>
              <div class="meta">Quantity: <strong>{{ product.quantity }}</strong></div>
              <div class="meta">Category: <span class="fw-semibold">{{ product.category }}</span></div>
              <div><span class="price-badge">$ {{ "%.2f"|format(product.price) }}</span></div>
            </div>

            <div class="card-footer">
              <form action="{{ url_for('add_to_cart', product_id=product.id) }}" method="POST">
                <button type="submit" class="btn btn-success w-100">Add to Cart</button>
              </form>
            </div>
          </div>
        </div>
        {% else %}
          <div class="col-12">
            <p class="text-center">No products found with these filters.</p>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
