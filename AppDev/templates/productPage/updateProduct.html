{% extends "base.html" %}
{% block title %}Update Product{% endblock %}

{% block content %}
{% from "includes/_formHelper.html" import render_field %}

<div class="container mt-4" style="max-width: 820px;">
  <h1 class="display-5 text-center">Update Product</h1>

  <div class="card shadow p-4 mt-3">
    <form id="updateProductForm" method="POST" action="" enctype="multipart/form-data" novalidate>
      {{ form.hidden_tag() }}

      <!-- Current image -->
      <div class="mb-3 text-center">
        <label class="form-label mb-2">Current Product Image</label><br>
        <img
          src="{{ url_for('static', filename='uploads/' + (product.image_filename or 'default.jpg')) }}"
          alt="Product Image" width="150" class="rounded border">
      </div>

      <!-- New image -->
      <div class="mb-3">
        <label for="product_image" class="form-label">Replace Image (optional)</label>
        {{ render_field(form.product_image, class="form-control", id="product_image", accept="image/*") }}
        <div class="invalid-feedback">Only JPG/PNG up to 2 MB.</div>
        <img id="newImagePreview" class="img-thumbnail mt-2 d-none" alt="Preview" width="150">
      </div>

      <!-- Product name -->
      <div class="mb-3">
        <label for="product_name" class="form-label">Product Name</label>
        {{ render_field(
            form.product_name,
            class="form-control",
            id="product_name",
            minlength="1",
            maxlength="150",
            pattern="^[A-Za-z0-9][A-Za-z0-9 \\-_'’(),.&/]{0,149}$",
            placeholder="e.g. Organic Wheat Seeds",
            required=True
        ) }}
        <div class="invalid-feedback">
          1–150 chars. Letters/numbers/spaces and - _ ’ ( ) , . & / allowed.
        </div>
      </div>

      <!-- Quantity -->
      <div class="mb-3">
        <label for="quantity" class="form-label">Quantity</label>
        {{ render_field(form.quantity, class="form-control", id="quantity", type="number", min="0", step="1", required=True) }}
        <div class="invalid-feedback">Quantity must be 0 or more.</div>
      </div>

      <!-- Category -->
      <div class="mb-3">
        <label for="category" class="form-label">Category</label>
        {{ render_field(form.category, class="form-select", id="category", required=True) }}
        <div class="invalid-feedback">Please select a category.</div>
      </div>

      <!-- Price -->
      <div class="mb-3">
        <label for="price" class="form-label">Price ($)</label>
        {{ render_field(form.price, class="form-control", id="price", type="number", min="0", step="0.01", inputmode="decimal", placeholder="e.g. 10.00", required=True) }}
        <div class="invalid-feedback">Enter a non-negative amount with ≤ 2 decimal places.</div>
      </div>

      <!-- CO₂ -->
      <div class="mb-3">
        <label for="co2" class="form-label">CO₂ Emissions (kg)</label>
        {{ render_field(form.co2, class="form-control", id="co2", type="number", min="0", step="0.01", inputmode="decimal", placeholder="e.g. 2.5") }}
        <div class="invalid-feedback">Must be 0 or more (≤ 2 decimal places).</div>
      </div>

      <!-- Description -->
      <div class="mb-3">
        <label for="product_description" class="form-label">Product Description</label>
        {{ render_field(form.product_description, class="form-control", id="product_description", rows="3", maxlength="1000", placeholder="Provide details about the product") }}
        <div class="form-text"><span id="descCount">0</span>/1000</div>
      </div>

      <button type="submit" class="btn btn-success w-100">Update Product</button>
    </form>

    <div class="text-center mt-3">
      <a href="{{ url_for('manageProduct') }}" class="btn btn-outline-secondary">Back to Inventory</a>
    </div>
  </div>
</div>

<script>
(function () {
  const form = document.getElementById('updateProductForm');

  const el = (id) => document.getElementById(id);
  const imgInput = el('product_image');
  const imgPreview = el('newImagePreview');
  const nameInput = el('product_name');
  const qtyInput  = el('quantity');
  const catInput  = el('category');
  const priceInput= el('price');
  const co2Input  = el('co2');
  const descInput = el('product_description');
  const descCount = el('descCount');

  // ---- helpers ----
  function toggleState(input, pass = null) {
    const valid = (pass === null) ? input.checkValidity() : pass;
    const hasValue = input.type === 'file'
      ? (input.files && input.files.length > 0)
      : String(input.value).trim() !== '';
    input.classList.toggle('is-valid', valid && hasValue);
    input.classList.toggle('is-invalid', !valid && (hasValue || input.required));
  }

  function twoDpValidity(n) {
    if (n === '' || n === null) return true;
    const s = String(n);
    const parts = s.split('.');
    return parts.length < 2 || parts[1].length <= 2;
  }

  function clampTwoDp(input) {
    if (!input.value) return;
    const num = Number(input.value);
    if (!Number.isNaN(num)) {
      const dp = (input.value.split('.')[1] || '').length;
      input.value = num.toFixed(Math.min(2, dp));
    }
  }

  // ---- image validate + preview ----
  if (imgInput) {
    imgInput.addEventListener('change', function () {
      const file = this.files && this.files[0];
      let ok = true;
      if (file) {
        const typeOk = /image\/(jpeg|jpg|png)/i.test(file.type);
        const sizeOk = file.size <= 2 * 1024 * 1024; // 2MB
        ok = typeOk && sizeOk;

        if (ok) {
          const url = URL.createObjectURL(file);
          imgPreview.src = url;
          imgPreview.classList.remove('d-none');
        } else {
          imgPreview.classList.add('d-none');
        }
      } else {
        imgPreview.classList.add('d-none');
      }
      toggleState(this, ok);
    });
  }

  // ---- name live feedback ----
  if (nameInput) {
    nameInput.addEventListener('input', () => toggleState(nameInput));
    nameInput.addEventListener('blur',  () => toggleState(nameInput));
  }

  // ---- quantity ----
  if (qtyInput) {
    qtyInput.addEventListener('input', () => toggleState(qtyInput));
    qtyInput.addEventListener('blur',  () => toggleState(qtyInput));
  }

  // ---- category ----
  if (catInput) {
    catInput.addEventListener('change', () => toggleState(catInput));
    catInput.addEventListener('blur',   () => toggleState(catInput));
  }

  // ---- price (≤ 2 dp) ----
  if (priceInput) {
    const validatePrice = () => {
      const ok = priceInput.value === '' ? false : twoDpValidity(priceInput.value) && Number(priceInput.value) >= 0;
      priceInput.setCustomValidity(ok ? '' : 'Two decimal places max.');
      toggleState(priceInput, ok);
    };
    priceInput.addEventListener('input', validatePrice);
    priceInput.addEventListener('change', () => { clampTwoDp(priceInput); validatePrice(); });
    priceInput.addEventListener('blur',   validatePrice);
  }

  // ---- co2 (optional, ≤ 2 dp) ----
  if (co2Input) {
    const validateCo2 = () => {
      if (co2Input.value === '') { co2Input.setCustomValidity(''); toggleState(co2Input, true); return; }
      const ok = twoDpValidity(co2Input.value) && Number(co2Input.value) >= 0;
      co2Input.setCustomValidity(ok ? '' : 'Two decimal places max.');
      toggleState(co2Input, ok);
    };
    co2Input.addEventListener('input', validateCo2);
    co2Input.addEventListener('change', () => { clampTwoDp(co2Input); validateCo2(); });
    co2Input.addEventListener('blur',   validateCo2);
  }

  // ---- description counter ----
  if (descInput && descCount) {
    const updateCount = () => { descCount.textContent = descInput.value.length; };
    updateCount();
    descInput.addEventListener('input', updateCount);
  }

  // ---- submit guard ----
  form.addEventListener('submit', function (e) {
    // Trigger checks
    [nameInput, qtyInput, catInput, priceInput, co2Input, descInput, imgInput].forEach((el) => {
      if (el) toggleState(el);
    });
    if (!form.checkValidity()) {
      e.preventDefault();
      e.stopPropagation();
    }
    form.classList.add('was-validated');
  });
})();
</script>
{% endblock %}
