{% extends "base.html" %}
{% block title %}Home - Cropzy{% endblock %}

{% block content %}

{# Global flash messages #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{# ===== HERO (full-bleed, dark overlay, taller) ===== #}
<div class="position-relative" style="left:50%;transform:translateX(-50%);width:100vw;">
  <section
    class="position-relative text-white overflow-hidden"
    style="
      background:
        linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.25) 40%, rgba(0,0,0,.55)),
        url('{{ url_for('static', filename='assets/crops-growing-in-thailand.jpg') }}') center/cover no-repeat;
      min-height: 70vh;">
    <div class="container">
      <div class="row align-items-center" style="min-height:70vh">
        <div class="col-lg-8 py-5">
          <span class="badge bg-success rounded-pill mb-3">Cropzy</span>
          <h1 class="display-5 fw-bold mb-3">
            {{ welcome_message if welcome_message else "Cultivating Growth, Harvesting Excellence." }}
          </h1>
          <p class="lead mb-4">
            Empowering farmers with tools and technology to boost yields, strengthen sustainability,
            and drive efficiency from seed to harvest.
          </p>
          <a href="/aboutUs" class="btn btn-success btn-lg me-2">About Us</a>
          <a href="#seasonal-updates" class="btn btn-outline-light btn-lg">Seasonal Updates</a>
        </div>
      </div>
    </div>
  </section>
</div>

{# ===== PAGE CANVAS (soft background) ===== #}
<div class="bg-body-tertiary">

  {# Quick tiles #}
  <section class="py-4 py-lg-5">
    <div class="container">
      <div class="row g-3 g-lg-4">
        <div class="col-12 col-md-4">
          <a href="#featured-articles" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h3 class="h5 mb-1">Featured Articles</h3>
                <p class="text-muted mb-3">Latest stories and insights.</p>
                <span class="btn btn-sm btn-outline-primary">Explore</span>
              </div>
            </div>
          </a>
        </div>
        <div class="col-12 col-md-4">
          <a href="{{ url_for('create_update') }}" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h3 class="h5 mb-1">Create Seasonal Update</h3>
                <p class="text-muted mb-3">Share what’s happening this season.</p>
                <span class="btn btn-sm btn-outline-primary">Get started</span>
              </div>
            </div>
          </a>
        </div>
        <div class="col-12 col-md-4">
          <a href="#co2-insights" class="text-decoration-none">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <h3 class="h5 mb-1">CO₂ Insights</h3>
                <p class="text-muted mb-3">Visualize product and category impact.</p>
                <span class="btn btn-sm btn-outline-primary">View charts</span>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </section>

  {# ===== FEATURED ARTICLES (cards grid) ===== #}
  <section id="featured-articles" class="pb-2 pb-lg-4">
    <div class="container">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4 p-lg-5">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h4 text-success m-0">Featured Articles</h2>
            {% if articles %}<span class="text-muted small">{{ articles|length }} items</span>{% endif %}
          </div>

          {% if articles %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
              {% for article in articles %}
              <div class="col">
                <div class="card h-100 border-0 shadow-sm">
                  <div class="ratio ratio-16x9">
                    <img src="{{ article.urlToImage or 'default-image.jpg' }}"
                         alt="Image for {{ article.title }}"
                         class="w-100 h-100" style="object-fit:cover;">
                  </div>
                  <div class="card-body">
                    <h3 class="h6 mb-2">{{ article.title }}</h3>
                    <p class="text-muted mb-3" style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
                      {{ article.description or 'No description available.' }}
                    </p>
                    <a href="{{ article.url }}" target="_blank" class="btn btn-primary btn-sm">Read More</a>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center text-muted py-4">No articles available at the moment.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- ===== SEASONAL UPDATES (clean, compact cards) ===== -->
<section id="seasonal-updates" class="py-4 py-lg-5">
  <div class="container">

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
      <h2 class="h4 text-success m-0">Seasonal Updates</h2>
      <a href="{{ url_for('create_update') }}" class="btn btn-primary">Create a Seasonal Update</a>
    </div>

    {# Section-specific flash (kept) #}
    <div class="text-center">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} d-inline-block text-start">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>

    {% if updates %}
      <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for update in updates %}
          {% set is_admin = current_user and current_user.status == 'admin' %}
          {% set is_owner = current_user and (update.get('owner_id') == current_user.user_id) %}
          {% set can_manage = is_admin or is_owner %}
          {% set season = (update.season or '')|lower %}

          <div class="col">
            <div class="card h-100 border-0 shadow-sm">
              <div class="card-body d-flex flex-column py-3">

                <!-- Header: title + date + small role badge -->
                <div class="d-flex align-items-start gap-2">
                  <h3 class="h6 mb-0 flex-grow-1">{{ update.title }}</h3>
                  <span class="small text-muted text-nowrap">{{ update.date }}</span>
                </div>
                <div class="mt-1">
                  {% if is_owner %}
                    <span class="badge rounded-pill text-bg-success">You</span>
                  {% elif is_admin %}
                    <span class="badge rounded-pill text-bg-secondary">Admin</span>
                  {% endif %}
                </div>

                <!-- Content -->
                <p class="text-muted my-3" title="{{ update.content }}"
                   style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
                  {{ update.content }}
                </p>

                <hr class="my-2">

                <!-- Footer: season chip + actions (always aligned bottom) -->
                <div class="mt-auto d-flex align-items-center justify-content-between">
                  <div>
                    {% if season == 'spring' %}
                      <span class="badge rounded-pill text-bg-success">Spring</span>
                    {% elif season == 'summer' %}
                      <span class="badge rounded-pill text-bg-warning text-dark">Summer</span>
                    {% elif season == 'autumn' %}
                      <span class="badge rounded-pill text-bg-secondary">Autumn</span>
                    {% elif season == 'winter' %}
                      <span class="badge rounded-pill text-bg-info text-dark">Winter</span>
                    {% else %}
                      <span class="badge rounded-pill text-bg-light text-dark">{{ update.season }}</span>
                    {% endif %}
                  </div>

                  <div class="d-flex gap-2">
                    {% if can_manage %}
                      <a href="{{ url_for('edit_update', index=loop.index0) }}" class="btn btn-sm btn-outline-primary">Edit</a>
                      <a href="{{ url_for('request_delete', index=loop.index0) }}" class="btn btn-sm btn-outline-danger">Delete</a>
                    {% else %}
                      <button type="button" class="btn btn-sm btn-outline-secondary" disabled
                              data-bs-toggle="tooltip"
                              data-bs-title="Only the creator or an admin can manage this update">
                        Edit / Delete
                      </button>
                    {% endif %}
                  </div>
                </div>

              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center text-muted py-4">No seasonal updates available at the moment.</div>
      </div>
    {% endif %}

  </div>
</section>


  {# ===== CO₂ INSIGHTS (3 cards) ===== #}
  <section id="co2-insights" class="pb-5">
    <div class="container">
      <h2 class="h4 text-success mb-3">CO₂ Emissions Insights</h2>
      <div class="row row-cols-1 row-cols-md-3 g-4">
        <div class="col">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h4 class="h6 text-muted mb-3 text-center">CO₂ Emissions by Product</h4>
              <div class="text-center">
                {% if chart1_data %}
                  <img src="data:image/png;base64,{{ chart1_data }}" class="img-fluid rounded" alt="CO₂ by Product">
                {% else %}
                  <p class="text-muted mb-0">No products available to display the chart.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h4 class="h6 text-muted mb-3 text-center">CO₂ Emissions by Product Category</h4>
              <div class="text-center">
                {% if chart2_data %}
                  <img src="data:image/png;base64,{{ chart2_data }}" class="img-fluid rounded" alt="CO₂ by Category">
                {% else %}
                  <p class="text-muted mb-0">No product category data available.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h4 class="h6 text-muted mb-3 text-center">Highest vs. Lowest CO₂ Emission Products</h4>
              <div class="text-center">
                {% if chart3_data %}
                  <img src="data:image/png;base64,{{ chart3_data }}" class="img-fluid rounded" alt="CO₂ High vs Low">
                {% else %}
                  <p class="text-muted mb-0">No emission comparison data available.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

</div> {# /bg-body-tertiary canvas #}

{# Local script just for this page #}
<script>
  // enable Bootstrap tooltips if present
  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    if (window.bootstrap && bootstrap.Tooltip) new bootstrap.Tooltip(el);
  });
</script>

{% endblock %}
